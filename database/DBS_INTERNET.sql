SET AUTOCOMMIT ON;
SET SERVEROUTPUT ON;
GRANT CREATE JOB TO sinhvien02;
GRANT MANAGE SCHEDULER TO sinhvien02;
GRANT EXECUTE ANY PROCEDURE TO sinhvien02;
SELECT * FROM USER_SYS_PRIVS WHERE PRIVILEGE = 'CREATE JOB';
SELECT * FROM USER_SYS_PRIVS WHERE PRIVILEGE = 'MANAGE SCHEDULER';

--  DDL for Table TAIKHOAN
--------------------------------------------------------
CREATE TABLE TAIKHOAN (
    USERNAME NVARCHAR2(10),
    PASS NVARCHAR2(20),
    HOTEN NVARCHAR2(40), 
    NGAYSINH DATE,
    CCCD NVARCHAR2(9),
    DIACHI NVARCHAR2(100),
    GIOITINH NVARCHAR2(3),
    SOTIENCONLAI NUMBER (*,0)
);

ALTER TABLE TAIKHOAN
ADD (LOAITK NVARCHAR2(2) DEFAULT 'KH' NOT NULL);

INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI, LOAITK) VALUES (0123456789,1,'Admin',TO_DATE('1995-09-30', 'YYYY-MM-DD'),018361853,'Ha Noi','Nam',0, 'QL');
COMMIT;

--------------------------------------------------------
--  DDL for Table MAYTINH
--------------------------------------------------------
CREATE TABLE MAYTINH (
    MAMAY CHAR(2),
    NGAYNHAP DATE,
    TRANGTHAI NVARCHAR2(1),
    NGAYBAOHANH DATE,
    GIANY NUMBER(*,0) 
    DEFAULT 7000 NOT NULL,
    MT_USERNAME VARCHAR2(10) 
    DEFAULT NULL
);

ALTER TABLE MAYTINH 
ADD (GIANY NUMBER(*,0) DEFAULT 7000 NOT NULL);

ALTER TABLE MAYTINH
ADD (MT_USERNAME VARCHAR2(10) DEFAULT NULL);

--------------------------------------------------------
--  DDL for Table SUDUNG
--------------------------------------------------------
CREATE TABLE SUDUNG (
    USERNAME VARCHAR2(10),
    MAMAY CHAR(2),
    TIEUTHU NUMBER(*,0),
    GIOBATDAU TIMESTAMP,
    GIOKETTHUC TIMESTAMP
);

ALTER TABLE SUDUNG 
MODIFY (TIEUTHU NUMBER(*,0));
--------------------------------------------------------
--  DDL for Table NHANVIEN
--------------------------------------------------------
CREATE TABLE NHANVIEN ( 
    MANV CHAR(4),
    HOTEN NVARCHAR2(40),
    DIENTHOAI NVARCHAR2(10),
    NGAYSINH DATE,
    NGAYVL DATE,
    CCCD NVARCHAR2(9),
    DIACHI NVARCHAR2(100),
    GIOITINH NVARCHAR2(3)
);
--------------------------------------------------------
--  DDL for Table SANPHAM
--------------------------------------------------------
CREATE TABLE SANPHAM (
    MASP NVARCHAR2(3),
    TENSP NVARCHAR2(40),
    DONVITINH NVARCHAR2(10),
    GIATIEN NUMBER(*,0),
    DANHMUC NVARCHAR2(10)
);

ALTER TABLE SANPHAM ADD (STATUS NUMBER(1, 0) DEFAULT 1);
--------------------------------------------------------
--  DDL for Table HOADON
--------------------------------------------------------
CREATE TABLE HOADON (
    SOHD NUMBER(*,0),
    NGAYHD DATE,
    USERNAME NVARCHAR2(10),
    TRIGIA NUMBER(*,0)
);

ALTER TABLE HOADON
DROP COLUMN MANV;

--------------------------------------------------------
--  DDL for Table CTHD
--------------------------------------------------------
CREATE TABLE CTHD (
    SOHD NUMBER(*,0),
    MASP NVARCHAR2(3),
    SL NUMBER(*,0)
);
--------------------------------------------------------

REM INSERTING into TAIKHOAN
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0918271031,1,'Nguyen Hoang Nam',TO_DATE('2002-03-18', 'YYYY-MM-DD'),018361811,'Ha Noi','Nam',100000);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0182827038,1,'Pham Van Khang',TO_DATE('2003-04-27', 'YYYY-MM-DD'),018361812,'Ha Noi','Nam',150000);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0938431942,1,'Ho Trung Nghia',TO_DATE('2002-01-22', 'YYYY-MM-DD'),018361813,'Ha Noi','Nu',50000);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0361956391,1,'Phan Bao Tuan',TO_DATE('2009-7-14', 'YYYY-MM-DD'),018361814,'Ha Noi','Nam',80000);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0946287423,1,'Le Ho Ngoc Minh',TO_DATE('1998-07-16', 'YYYY-MM-DD'),018361815,'Ha Noi','Nu',68500);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0963518774,1,'Dinh Tien Hoang',TO_DATE('2004-12-30', 'YYYY-MM-DD'),018361816,'Ha Noi','Nam',5000);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0836778999,1,'Le Tien Dat',TO_DATE('1997-07-28', 'YYYY-MM-DD'),018361817,'Ha Noi','Nam',0);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0824983293,1,'Pham Ho Truc Linh',TO_DATE('2008-09-13', 'YYYY-MM-DD'),018361818,'Ha Noi','Nu',78500);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0192890371,1,'Doan Cong Tai',TO_DATE('2001-01-21', 'YYYY-MM-DD'),018361819,'Ha Noi','Nam',10520);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0844344944,1,'Nham Manh Dung',TO_DATE('1993-12-12', 'YYYY-MM-DD'),018361821,'Ha Noi','Nam',89610);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0975432875,1,'Nguyen Thi Hong Ngoc',TO_DATE('2004-12-17', 'YYYY-MM-DD'),018361822,'Ha Noi','Nu',12000);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0745666666,1,'Phan Thi Chau Trinh',TO_DATE('1984-03-31', 'YYYY-MM-DD'),018361823,'Ha Noi','Nu',540000);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0936826111,1,'Luong Ngoc Hoang',TO_DATE('2002-07-31', 'YYYY-MM-DD'),018361824,'Ha Noi','Nam',63590);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0987654321,1,'Hong Ngoc Luong',TO_DATE('2002-08-31', 'YYYY-MM-DD'),018361825,'Ha Noi','Nam',83690);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0392772277,1,'Hoang Cong Tai',TO_DATE('1995-04-01', 'YYYY-MM-DD'),018361826,'Ha Noi','Nam',104800);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0941862997,1,'Nguyen Hoang Gia Bao',TO_DATE('1995-04-02', 'YYYY-MM-DD'),018361827,'Ha Noi','Nam',0);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0819835580,1,'Nguyen Thanh Nam',TO_DATE('1999-01-02', 'YYYY-MM-DD'),018361828,'Ha Noi','Nam',700);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0942418110,1,'Luong Thanh Tuan',TO_DATE('2007-07-13', 'YYYY-MM-DD'),018361829,'Ha Noi','Nam',8500);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0129778000,1,'Nguyen Tung Son',TO_DATE('2004-10-17', 'YYYY-MM-DD'),018361831,'Ha Noi','Nam',107200);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0999555728,1,'Pham Nam Hai',TO_DATE('2000-12-12', 'YYYY-MM-DD'),018361832,'Ha Noi','Nam',3000000);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0359740182,1,'Phan Di Anh',TO_DATE('2010-07-25', 'YYYY-MM-DD'),018361833,'Ha Noi','Nu',46000);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0467810947,1,'Le Thi Kim Lien',TO_DATE('1973-03-31', 'YYYY-MM-DD'),018361834,'Ha Noi','Nu',0);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0947293856,1,'Doan Thanh Ha',TO_DATE('1999-12-01', 'YYYY-MM-DD'),018361835,'Ha Noi','Nu',69000);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0371057101,1,'Le Quoc Tuan',TO_DATE('2004-07-07', 'YYYY-MM-DD'),018361836,'Ha Noi','Nam',2300);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0573957992,1,'Khuc Thi Huong',TO_DATE('2002-01-21', 'YYYY-MM-DD'),0183618237,'Ha Noi','Nu',69000);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0845775983,1,'Vo Minh Thuan',TO_DATE('2002-03-09', 'YYYY-MM-DD'),0183618238,'Ha Noi','Nam',5500);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0468933964,1,'Dinh Cong Minh',TO_DATE('2002-03-13', 'YYYY-MM-DD'),018361839,'Ha Noi','Nam',7800);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0946222275,1,'Nguyen Ngoc Trinh',TO_DATE('2005-02-17', 'YYYY-MM-DD'),018361841,'Ha Noi','Nu',980340);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0764338986,1,'Le Trung Hau',TO_DATE('2007-07-14', 'YYYY-MM-DD'),018361842,'Ha Noi','Nam',1050300);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0783442447,1,'Nguyen Thi Nam Em',TO_DATE('2008-05-17', 'YYYY-MM-DD'),018361843,'Ha Noi','Nu',54870);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0128789888,1,'Nguyen Thuc Thuy Tien',TO_DATE('2008-03-10', 'YYYY-MM-DD'),018361844,'Ha Noi','Nu',0);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0564870989,1,'Bui Anh Tuan',TO_DATE('1993-11-08', 'YYYY-MM-DD'),018361845,'Ha Noi','Nam',28000);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0458309861,1,'Hong Phuoc Thinh',TO_DATE('2004-11-08', 'YYYY-MM-DD'),018361846,'Ha Noi','Nam',0);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0824909972,1,'Nguyen Xuan Hinh',TO_DATE('2004-01-21', 'YYYY-MM-DD'),018361847,'Ha Noi','Nam',300);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0824903883,1,'Nghiem Vu Hoang Long',TO_DATE('2004-08-19', 'YYYY-MM-DD'),018361848,'Ha Noi','Nam',1000);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0754687534,1,'Le Minh Hieu',TO_DATE('1994-11-12', 'YYYY-MM-DD'),018361849,'Ha Noi','Nam',10000);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0678466665,1,'Tran Nguyen Huu Tai',TO_DATE('2006-07-19', 'YYYY-MM-DD'),018361851,'Ha Noi','Nam',620);
INSERT INTO TAIKHOAN (USERNAME, PASS, HOTEN, NGAYSINH, CCCD, DIACHI, GIOITINH, SOTIENCONLAI) VALUES (0918881886,1,'Dang Ngoc Mai',TO_DATE('2009-12-03', 'YYYY-MM-DD'),018361852,'Ha Noi','Nu',0);

REM INSERTING into MAYTINH
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (01,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (02,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (03,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (04,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (05,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (06,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (07,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (08,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (09,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (10,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (11,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (12,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (13,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (14,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (15,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (16,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (17,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (18,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (19,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));
INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH) VALUES (20,TO_DATE('2022-01-28', 'YYYY-MM-DD'),'Y',TO_DATE('2027-01-28', 'YYYY-MM-DD'));

REM INSERTING into SUDUNG
INSERT INTO SUDUNG (USERNAME, MAMAY, TIEUTHU, GIOBATDAU, GIOKETTHUC) VALUES ();

REM INSERTING into NHANVIEN
INSERT INTO NHANVIEN (MANV, HOTEN, DIENTHOAI, NGAYSINH, NGAYVL, CCCD, DIACHI, GIOITINH) VALUES ('NV01','Pham Thuy Kieu',0789554227,TO_DATE('1999-02-27', 'YYYY-MM-DD'),TO_DATE('2022-02-15', 'YYYY-MM-DD'),018461701, 'Ha Noi', 'Nu');
INSERT INTO NHANVIEN (MANV, HOTEN, DIENTHOAI, NGAYSINH, NGAYVL, CCCD, DIACHI, GIOITINH) VALUES ('NV02','Nguyen Hoang Bao Ngoc',0393772998,TO_DATE('2002-01-09', 'YYYY-MM-DD'),TO_DATE('2022-02-15', 'YYYY-MM-DD'),018461702, 'Ha Noi', 'Nu');
INSERT INTO NHANVIEN (MANV, HOTEN, DIENTHOAI, NGAYSINH, NGAYVL, CCCD, DIACHI, GIOITINH) VALUES ('NV03','Tran Hoang Nghia',0944700625,TO_DATE('1997-11-30', 'YYYY-MM-DD'),TO_DATE('2022-02-15', 'YYYY-MM-DD'),018461703, 'Ha Noi', 'Nam');
INSERT INTO NHANVIEN (MANV, HOTEN, DIENTHOAI, NGAYSINH, NGAYVL, CCCD, DIACHI, GIOITINH) VALUES ('NV04','Dang Hoang Gia Bao',0394777777,TO_DATE('1999-08-04', 'YYYY-MM-DD'),TO_DATE('2022-02-15', 'YYYY-MM-DD'),018461704, 'Ha Noi', 'Nam');
INSERT INTO NHANVIEN (MANV, HOTEN, DIENTHOAI, NGAYSINH, NGAYVL, CCCD, DIACHI, GIOITINH) VALUES ('NV05','Luong Anh Huy',0918819333,TO_DATE('2003-02-26', 'YYYY-MM-DD'),TO_DATE('2022-02-15', 'YYYY-MM-DD'),018461705, 'Ha Noi', 'Nam');

REM INSERTING into SANPHAM
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('D01','Sting','Lon','15000','Do uong');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('D02','Coca','Lon','15000','Do uong');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('D03','Pepsi','Lon','15000','Do uong');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('D04','7Up','Lon','15000','Do uong');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('D05','Sprite','Lon','15000','Do uong');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('D06','Mirinda Xa Xi','Lon','15000','Do uong');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('D07','Mirinda Cam','Lon','15000','Do uong');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('D08','Mirinda Soda Kem','Lon','15000','Do uong');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('D09','Mirinda Soda Kem Viet Quat','Lon','15000','Do uong');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('D10','Nuoc Suoi','Chai','10000','Do uong');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F01','Mi Kho 1g','To','18000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F02','Mi Kho Xuc Xich 1g','To','23000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F03','Mi Kho Trung 1g','To','21000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F04','Mi Kho Xuc Xich Trung 1g','To','26000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F05','Mi Kho 2g','To','20000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F06','Mi Kho Xuc Xich 2g','To','25000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F07','Mi Kho Trung 2g','To','23000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F08','Mi Kho Xuc Xich Trung 2g','To','28000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F09','Mi Nuoc 1g','To','18000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F10','Mi Nuoc Xuc Xich 1g','To','23000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F11','Mi Nuoc Trung 1g','To','21000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F12','Mi Nuoc Xuc Xich Trung 1g','To','26000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F13','Mi Nuoc 2g','To','20000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F14','Mi Nuoc Xuc Xich 2g','To','25000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F15','Mi Nuoc Trung 2g','To','23000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F16','Mi Nuoc Xuc Xich Trung 2g','To','28000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F17','Com Tron Han Quoc','Dia','38000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F18','Com Chien Thap Cam','Dia','35000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F19','Com Suon','Dia','35000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F20','Combo Do Chien Nho','Dia','15000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F21','Combo Do Chien Vua','Dia','25000','Do an');
INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC) VALUES ('F22','Combo Do Chien Lon','Dia','35000','Do an');

REM INSERTING into HOADON
SELECT * FROM HOADON
DELETE FROM HOADON
INSERT INTO HOADON (SOHD, NGAYHD, USERNAME, TRIGIA) VALUES (1, TO_DATE('2022-03-28', 'YYYY-MM-DD'), 0573957992, 50000);
INSERT INTO HOADON (SOHD, NGAYHD, USERNAME, TRIGIA) VALUES (2, TO_DATE('2022-05-17', 'YYYY-MM-DD'), 0468933964, 75000);
INSERT INTO HOADON (SOHD, NGAYHD, USERNAME, TRIGIA) VALUES (3, TO_DATE('2022-09-19', 'YYYY-MM-DD'), 0745666666, 15000);
INSERT INTO HOADON (SOHD, NGAYHD, USERNAME, TRIGIA) VALUES (4, TO_DATE('2022-12-21', 'YYYY-MM-DD'), 0824909972, 20000);
INSERT INTO HOADON (SOHD, NGAYHD, USERNAME, TRIGIA) VALUES (5, TO_DATE('2023-12-12', 'YYYY-MM-DD'), 0999555728, 40000);
INSERT INTO HOADON (SOHD, NGAYHD, USERNAME, TRIGIA) VALUES (6, TO_DATE('2023-01-01', 'YYYY-MM-DD'), 0573957992, 100000);

REM INSERTING into CTHD
delete from cthd
select * from cthd
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1, 'D01', 1);
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (1, 'F18', 1);
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (2, 'D07', 1);
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (2, 'F14', 1);
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (2, 'F22', 1);
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (3, 'D01', 1);
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (4, 'F05', 1);
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (5, 'D04', 1);
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (5, 'F21', 1);
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (6, 'D10', 3);
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (6, 'F19', 1);
INSERT INTO CTHD (SOHD, MASP, SL) VALUES (6, 'F22', 1);

--ADD PRIMARY AND FOREIGN KEY
ALTER TABLE TAIKHOAN MODIFY (USERNAME NOT NULL);
ALTER TABLE MAYTINH MODIFY (MAMAY NOT NULL);
ALTER TABLE SUDUNG MODIFY (USERNAME NOT NULL, MAMAY NOT NULL);
ALTER TABLE SUDUNG MODIFY (GIOBATDAU NOT NULL);
ALTER TABLE NHANVIEN MODIFY (MANV NOT NULL);
ALTER TABLE SANPHAM MODIFY (MASP NOT NULL);
ALTER TABLE HOADON MODIFY (SOHD NOT NULL);
ALTER TABLE CTHD MODIFY (SOHD NOT NULL, MASP NOT NULL);


ALTER TABLE TAIKHOAN ADD CONSTRAINT PK_USERNAME PRIMARY KEY (USERNAME);
ALTER TABLE MAYTINH ADD CONSTRAINT PK_MAMAY PRIMARY KEY (MAMAY);
ALTER TABLE SUDUNG ADD CONSTRAINT PK_USERNAME_MAMAY PRIMARY KEY (USERNAME, MAMAY);
ALTER TABLE NHANVIEN ADD CONSTRAINT PK_MANV PRIMARY KEY (MANV);
ALTER TABLE SANPHAM ADD CONSTRAINT PK_MASP PRIMARY KEY (MASP);
ALTER TABLE HOADON ADD CONSTRAINT PK_SOHD PRIMARY KEY (SOHD);
ALTER TABLE CTHD ADD CONSTRAINT PK_SOHD_MASP PRIMARY KEY (SOHD, MASP); 

ALTER TABLE SUDUNG DROP CONSTRAINT PK_USERNAME_MAMAY;
ALTER TABLE SUDUNG ADD CONSTRAINT PK_USERNAME_MAMAY_GIOBATDAU PRIMARY KEY (USERNAME, MAMAY, GIOBATDAU);


--TRIGGER

--* CTHD
DROP TRIGGER CHECK_CTHD;
CREATE OR REPLACE TRIGGER CHECK_CTHD
BEFORE UPDATE OR DELETE OR INSERT ON CTHD
FOR EACH ROW 
DECLARE
    TG_TRIGIA_CT HOADON.TRIGIA%TYPE;
    TG_TRIGIA_HD HOADON.TRIGIA%TYPE;
BEGIN 
    SELECT SUM(CT.SL * SP.GIATIEN) INTO TG_TRIGIA_CT
    FROM CTHD CT JOIN SANPHAM SP 
    ON CT.MASP = SP.MASP 
    WHERE CT.SOHD = :NEW.SOHD;
    
    SELECT TRIGIA INTO TG_TRIGIA_HD 
    FROM HOADON 
    WHERE SOHD = :NEW.SOHD;
    
    IF TG_TRIGIA_CT <> TG_TRIGIA_HD THEN 
        RAISE_APPLICATION_ERROR(-20015, 'Tri gia hoa don phai trung khop voi tong tien cac san pham trong chi tiet hoa don');
    END IF;
END;

--* SU DUNG
--1) Tu dong them gia tri con thieu khi them du lieu vao SUDUNG
CREATE OR REPLACE TRIGGER trg_before_insert_sudung
BEFORE INSERT ON SUDUNG
FOR EACH ROW
DECLARE
    v_sotienconlai TAIKHOAN.SOTIENCONLAI%TYPE;
    v_giany MAYTINH.GIANY%TYPE;
BEGIN
    SELECT SOTIENCONLAI INTO v_sotienconlai
    FROM TAIKHOAN
    WHERE USERNAME = :NEW.USERNAME;

    SELECT GIANY INTO v_giany
    FROM MAYTINH
    WHERE MAMAY = :NEW.MAMAY;

    :NEW.TIEUTHU := ((v_sotienconlai / v_giany) * 60);

    :NEW.GIOBATDAU := SYSDATE;

    :NEW.GIOKETTHUC := NULL;

    UPDATE MAYTINH
    SET TRANGTHAI = 'N'
    WHERE MAMAY = :NEW.MAMAY;
    
    UPDATE MAYTINH
    SET MT_USERNAME = :NEW.USERNAME 
    WHERE MAMAY = :NEW.MAMAY;
END;

--2) Moi tai khoan hoac may tinh trong SUDUNG la duy nhat 
CREATE OR REPLACE TRIGGER CHECK_UNIQUE_USE
BEFORE INSERT ON SUDUNG 
FOR EACH ROW 
DECLARE 
    TG_CHECK NUMBER;
BEGIN 
    SELECT COUNT(*) INTO TG_CHECK 
    FROM SUDUNG 
    WHERE (USERNAME = :NEW.USERNAME AND GIOKETTHUC IS NULL)
    OR (MAMAY = :NEW.MAMAY AND GIOKETTHUC IS NULL);
    
    IF TG_CHECK > 0 THEN 
        RAISE_APPLICATION_ERROR(-20001, 'Moi tai khoan chi su dung vao mot may tinh duy nhat');
    END IF; 
END;

--3) Moi tai khoan chi duoc dang nhap vao may tinh khi so phut con lai tieu thu >= 1 
CREATE OR REPLACE TRIGGER CHECK_ENOUGH_MONEY 
BEFORE INSERT ON SUDUNG 
FOR EACH ROW 
DECLARE 
BEGIN     
    IF :NEW.TIEUTHU < 1 THEN 
        ROLLBACK;
        RAISE_APPLICATION_ERROR(-20002, 'Tai khoan khong du tien');    
    END IF;
END;

--4)Cap nhap so tien con lai sau khi choi xong
CREATE OR REPLACE TRIGGER CAPNHAT_TIENCONLAI 
BEFORE UPDATE ON SUDUNG 
FOR EACH ROW 
DECLARE 
    TG_GIANY MAYTINH.GIANY%TYPE;
BEGIN 
    SELECT GIANY INTO TG_GIANY 
    FROM MAYTINH 
    WHERE MAMAY = :NEW.MAMAY;
    
    IF :NEW.GIOKETTHUC IS NOT NULL THEN 
        UPDATE TAIKHOAN 
        SET SOTIENCONLAI = (ROUND((:NEW.TIEUTHU/60) * TG_GIANY))
        WHERE USERNAME = :NEW.USERNAME;
    END IF;
END;

--PROCEDURE 

--* NHAN VIEN 
--1) Them nhan vien 
CREATE OR REPLACE PROCEDURE SP_THEM_NHANVIEN (
    P_HOTEN NHANVIEN.HOTEN%TYPE,
    P_DIENTHOAI NHANVIEN.DIENTHOAI%TYPE, 
    P_NGAYSINH NHANVIEN.NGAYSINH%TYPE, 
    P_NGAYVL NHANVIEN.NGAYVL%TYPE,
    P_CCCD NHANVIEN.CCCD%TYPE, 
    P_DIACHI NHANVIEN.DIACHI%TYPE, 
    P_GIOITINH NHANVIEN.GIOITINH%TYPE
)
AS
    P_MANV NHANVIEN.MANV%TYPE;
    P_MAX_MANV NUMBER := 0;
    P_FOUND_MANV BOOLEAN := FALSE;
    CURSOR C_MANV IS 
        SELECT TO_NUMBER(SUBSTR(MANV, 3)) AS NUM_MANV 
        FROM NHANVIEN 
        ORDER BY NUM_MANV;
BEGIN 
    FOR i IN C_MANV LOOP 
        P_MAX_MANV := P_MAX_MANV + 1; 
        IF P_MAX_MANV <> i.NUM_MANV THEN 
            P_MANV := 'NV' || TO_CHAR(P_MAX_MANV, 'FM00');
            P_FOUND_MANV := TRUE; 
            EXIT; 
        END IF; 
    END LOOP;  

    IF NOT P_FOUND_MANV THEN 
        P_MAX_MANV := P_MAX_MANV + 1; 
        P_MANV := 'NV' || TO_CHAR(P_MAX_MANV, 'FM00');
    END IF;
    
    INSERT INTO NHANVIEN (MANV, HOTEN, DIENTHOAI, NGAYSINH, NGAYVL, CCCD, DIACHI, GIOITINH)
    VALUES (P_MANV, P_HOTEN, P_DIENTHOAI, P_NGAYSINH, P_NGAYVL, P_CCCD, P_DIACHI, P_GIOITINH);
END;

--*MAYTINH 
--1) Them may tinh
CREATE OR REPLACE PROCEDURE SP_THEM_MAYTINH ( 
    P_NGAYNHAP MAYTINH.NGAYNHAP%TYPE, 
    P_TRANGTHAI MAYTINH.TRANGTHAI%TYPE, 
    P_NGAYBAOHANH MAYTINH.NGAYBAOHANH%TYPE, 
    P_GIANY MAYTINH.GIANY%TYPE
)
AS 
    P_MAMAY MAYTINH.MAMAY%TYPE;
    P_MAX_MAMAY NUMBER := 0; 
    P_FOUND_MAMAY BOOLEAN := FALSE; 
    CURSOR C_MAMAY IS 
        SELECT TO_NUMBER(MAMAY) AS NUM_MAMAY 
        FROM MAYTINH 
        ORDER BY NUM_MAMAY; 

    v_trangthai MAYTINH.TRANGTHAI%TYPE;
BEGIN 
    FOR i IN C_MAMAY LOOP 
        P_MAX_MAMAY := P_MAX_MAMAY + 1; 
        IF P_MAX_MAMAY <> i.NUM_MAMAY THEN 
            P_MAMAY := TO_CHAR(P_MAX_MAMAY, 'FM00');
            P_FOUND_MAMAY := TRUE; 
            EXIT;
        END IF; 
    END LOOP;

    IF NOT P_FOUND_MAMAY THEN 
        P_MAX_MAMAY := P_MAX_MAMAY + 1; 
        P_MAMAY := TO_CHAR(P_MAX_MAMAY, 'FM00'); 
    END IF;

    BEGIN
        SELECT TRANGTHAI INTO v_trangthai
        FROM MAYTINH
        WHERE MAMAY = P_MAMAY;
        
        IF v_trangthai = 'N' THEN
            RAISE_APPLICATION_ERROR(-20002, 'May tinh dang duoc su dung');
        END IF;
    EXCEPTION
        WHEN NO_DATA_FOUND THEN
            NULL;
    END;

    INSERT INTO MAYTINH (MAMAY, NGAYNHAP, TRANGTHAI, NGAYBAOHANH, GIANY) 
    VALUES (P_MAMAY, P_NGAYNHAP, P_TRANGTHAI, P_NGAYBAOHANH, P_GIANY); 
END;

--* SUDUNG 
--1) Chu dong ket thuc su dung truoc khi het tien
CREATE OR REPLACE PROCEDURE sp_end_usage (
    p_username IN SUDUNG.USERNAME%TYPE,
    p_mamay IN SUDUNG.MAMAY%TYPE
)
AS
BEGIN
    UPDATE SUDUNG
    SET GIOKETTHUC = SYSDATE
    WHERE USERNAME = p_username AND MAMAY = p_mamay AND GIOKETTHUC IS NULL;
    
    UPDATE MAYTINH
    SET TRANGTHAI = 'Y'
    WHERE MAMAY = p_mamay;
    
    UPDATE MAYTINH 
    SET MT_USERNAME = NULL
    WHERE MAMAY = p_mamay;

    BEGIN
        XOA_JOB_GIAM_TIEUTHU_FOR_USN(p_username);
    END;
END;

--2) Giam gia tri TIEUTHU 
CREATE OR REPLACE PROCEDURE GIAM_TIEUTHU_FOR_USN (
    SP_USERNAME IN SUDUNG.USERNAME%TYPE
)
AS 
    v_mamay SUDUNG.MAMAY%TYPE;
BEGIN 
    SELECT MAMAY INTO v_mamay 
    FROM SUDUNG 
    WHERE USERNAME = SP_USERNAME AND ROWNUM = 1 AND GIOKETTHUC IS NULL;
    
    UPDATE SUDUNG 
    SET TIEUTHU = CASE 
                    WHEN TIEUTHU > 1 THEN TIEUTHU - 1
                    ELSE 0
                  END
    WHERE USERNAME = SP_USERNAME AND GIOKETTHUC IS NULL;

    BEGIN
        PROC_CHECK_TIEUTHU(SP_USERNAME, v_mamay);
    END;
END;

--3) Tao job de giam tieu thu 
CREATE OR REPLACE PROCEDURE TAO_JOB_GIAM_TIEUTHU_FOR_USN (
    P_USERNAME IN SUDUNG.USERNAME%TYPE
) 
AS
BEGIN
    BEGIN
        DBMS_SCHEDULER.drop_job('GIAM_TIEUTHU_JOB_FOR_' || P_USERNAME);
    EXCEPTION
        WHEN OTHERS THEN
            IF SQLCODE != -27475 THEN 
                RAISE;
            END IF;
    END;

    DBMS_SCHEDULER.create_job (
        job_name        => 'GIAM_TIEUTHU_JOB_FOR_' || P_USERNAME,
        job_type        => 'PLSQL_BLOCK',
        job_action      => 'BEGIN GIAM_TIEUTHU_FOR_USN(' || P_USERNAME || '); END;',
        start_date      => SYSTIMESTAMP,
        repeat_interval => 'FREQ=MINUTELY; INTERVAL=1;',
        enabled         => TRUE
    );
END;

--4) Xoa job de giam tieu thu
CREATE OR REPLACE PROCEDURE XOA_JOB_GIAM_TIEUTHU_FOR_USN (
    P_USERNAME IN SUDUNG.USERNAME%TYPE
) 
AS
BEGIN
    BEGIN 
        DBMS_SCHEDULER.drop_job('GIAM_TIEUTHU_JOB_FOR_' || P_USERNAME);
    EXCEPTION
        WHEN OTHERS THEN
            IF SQLCODE != -27475 THEN 
                RAISE;
            END IF;
    END;
END;    

--5) Them su dung 
CREATE OR REPLACE PROCEDURE SP_THEM_SUDUNG ( 
    P_USERNAME SUDUNG.USERNAME%TYPE,
    P_MAMAY SUDUNG.MAMAY%TYPE 
) 
AS 
BEGIN 
    INSERT INTO SUDUNG (USERNAME, MAMAY) 
    VALUES (P_USERNAME, P_MAMAY); 
    
    BEGIN 
        TAO_JOB_GIAM_TIEUTHU_FOR_USN(P_USERNAME); 
    END;
END;

--6) Kiem tra TIEUTHU = 0 
CREATE OR REPLACE PROCEDURE PROC_CHECK_TIEUTHU (
    p_username IN SUDUNG.USERNAME%TYPE,
    p_mamay IN SUDUNG.MAMAY%TYPE
)
AS
    p_tieuthu SUDUNG.TIEUTHU%TYPE;
BEGIN
    SELECT TIEUTHU INTO p_tieuthu 
    FROM SUDUNG 
    WHERE USERNAME = p_username AND MAMAY = p_mamay
    AND GIOBATDAU = (SELECT MAX(GIOBATDAU) 
                     FROM SUDUNG 
                     WHERE USERNAME = p_username AND MAMAY = p_mamay);
    
    IF p_tieuthu = 0 THEN
        UPDATE SUDUNG
        SET GIOKETTHUC = SYSDATE
        WHERE USERNAME = p_username AND MAMAY = p_mamay AND TIEUTHU = 0 
        AND GIOBATDAU = (SELECT MAX(GIOBATDAU) 
                        FROM SUDUNG 
                        WHERE USERNAME = p_username AND MAMAY = p_mamay);
        
        UPDATE MAYTINH
        SET TRANGTHAI = 'Y',
            MT_USERNAME = NULL
        WHERE MAMAY = p_mamay AND EXISTS (
            SELECT 1 FROM SUDUNG WHERE USERNAME = p_username AND MAMAY = p_mamay AND TIEUTHU = 0 
            AND GIOBATDAU = (SELECT MAX(GIOBATDAU) 
                            FROM SUDUNG 
                            WHERE USERNAME = p_username AND MAMAY = p_mamay));
                            
        BEGIN
            XOA_JOB_GIAM_TIEUTHU_FOR_USN(p_username);
        END;
    END IF;
END;

--7) CAPNHAT TIEUTHU khi SOTIENCONLAI duoc cap nhat 
CREATE OR REPLACE PROCEDURE TAM_DUNG_VA_CAP_NHAT_TIEUTHU (
    P_USERNAME IN SUDUNG.USERNAME%TYPE,
    P_TIEN_THEMVAO IN TAIKHOAN.SOTIENCONLAI%TYPE
)
AS
    P_TIEUTHU_CU SUDUNG.TIEUTHU%TYPE;
    P_TIEUTHU_MOI SUDUNG.TIEUTHU%TYPE;
    P_GIANY MAYTINH.GIANY%TYPE;
    P_MAMAY SUDUNG.MAMAY%TYPE;
    P_SOTIENCONLAI_MOI TAIKHOAN.SOTIENCONLAI%TYPE;
BEGIN
    DBMS_SCHEDULER.disable('GIAM_TIEUTHU_JOB_FOR_' || P_USERNAME);
    
    SELECT TIEUTHU INTO P_TIEUTHU_CU 
    FROM SUDUNG 
    WHERE USERNAME = P_USERNAME AND GIOKETTHUC IS NULL;
    
    SELECT MAMAY INTO P_MAMAY 
    FROM SUDUNG 
    WHERE USERNAME = P_USERNAME AND GIOKETTHUC IS NULL;
    
    SELECT GIANY INTO P_GIANY 
    FROM MAYTINH 
    WHERE MAMAY = P_MAMAY;
    
    P_TIEUTHU_MOI := (P_TIEUTHU_CU + ROUND((P_TIEN_THEMVAO / P_GIANY) * 60));
    
    P_SOTIENCONLAI_MOI := (ROUND((P_TIEUTHU_MOI/60) * P_GIANY));

    UPDATE SUDUNG
    SET TIEUTHU = P_TIEUTHU_MOI
    WHERE USERNAME = P_USERNAME AND GIOKETTHUC IS NULL;
    
    UPDATE TAIKHOAN 
    SET SOTIENCONLAI = P_SOTIENCONLAI_MOI 
    WHERE USERNAME = P_USERNAME;

    DBMS_SCHEDULER.enable('GIAM_TIEUTHU_JOB_FOR_' || P_USERNAME);
END;

--*SANPHAM 
--1) Them san pham 
CREATE OR REPLACE PROCEDURE SP_THEM_SANPHAM (
    P_TENSP SANPHAM.TENSP%TYPE,
    P_DONVITINH SANPHAM.DONVITINH%TYPE,
    P_GIATIEN SANPHAM.GIATIEN%TYPE,
    P_DANHMUC SANPHAM.DANHMUC%TYPE
)
AS
    P_MASP SANPHAM.MASP%TYPE;
    P_PREFIX CHAR(1);
    P_MAX_MASP NUMBER := 0;
    P_FOUND_MASP BOOLEAN := FALSE;
    CURSOR C_MASP IS
        SELECT TO_NUMBER(SUBSTR(MASP, 2, 2)) AS NUM_MASP
        FROM SANPHAM
        WHERE SUBSTR(MASP, 1, 1) = P_PREFIX
        ORDER BY NUM_MASP;
BEGIN
    IF P_DANHMUC = 'Do uong' THEN
        P_PREFIX := 'D';
    ELSIF P_DANHMUC = 'Do an' THEN
        P_PREFIX := 'F';
    ELSE
        RAISE_APPLICATION_ERROR(-20999, 'Danh muc khong hop le.');
    END IF;

    FOR i IN C_MASP LOOP
        P_MAX_MASP := P_MAX_MASP + 1;
        IF P_MAX_MASP <> i.NUM_MASP THEN
            P_MASP := P_PREFIX || TO_CHAR(P_MAX_MASP, 'FM00');
            P_FOUND_MASP := TRUE;
            EXIT; 
        END IF;
    END LOOP;
    
    IF NOT P_FOUND_MASP THEN
        P_MAX_MASP := P_MAX_MASP + 1;
        P_MASP := P_PREFIX || TO_CHAR(P_MAX_MASP, 'FM00');
    END IF;
    
    INSERT INTO SANPHAM (MASP, TENSP, DONVITINH, GIATIEN, DANHMUC)
    VALUES (P_MASP, P_TENSP, P_DONVITINH, P_GIATIEN, P_DANHMUC);
END;

--* HOADON 
--1) Them hoa don 
CREATE OR REPLACE PROCEDURE SP_THEM_HOADON (
    P_NGAYHD HOADON.NGAYHD%TYPE, 
    P_USERNAME HOADON.USERNAME%TYPE
)
AS 
    P_SOHD HOADON.SOHD%TYPE;
    P_MAX_SOHD NUMBER := 0; 
    P_FOUND_SOHD BOOLEAN := FALSE; 
    CURSOR C_SOHD IS 
        SELECT SOHD AS NUM_SOHD 
        FROM HOADON 
        ORDER BY NUM_SOHD; 
BEGIN 
    FOR i IN C_SOHD LOOP 
        P_MAX_SOHD := P_MAX_SOHD + 1; 
        IF P_MAX_SOHD <> i.NUM_SOHD THEN 
            P_SOHD := P_MAX_SOHD;
            P_FOUND_SOHD := TRUE; 
            EXIT;
        END IF; 
    END LOOP;

    IF NOT P_FOUND_SOHD THEN 
        P_MAX_SOHD := P_MAX_SOHD + 1; 
        P_SOHD := P_MAX_SOHD; 
    END IF;
    
    INSERT INTO HOADON (SOHD, NGAYHD, USERNAME, TRIGIA) 
    VALUES (P_SOHD, P_NGAYHD, P_USERNAME, NULL);
END;

--2) Xoa hoa don
CREATE OR REPLACE PROCEDURE SP_XOA_HOADON ( 
    P_SOHD IN HOADON.USERNAME%TYPE
)
AS 
BEGIN 

    DELETE FROM HOADON WHERE SOHD = P_SOHD;
    DELETE FROM CTHD WHERE SOHD = P_SOHD;
    
END;

--* CTHD 
--1) Them chi tiet hoa don 
CREATE OR REPLACE PROCEDURE SP_THEM_CTHD (
    P_SOHD IN CTHD.SOHD%TYPE, 
    P_MASP IN CTHD.MASP%TYPE, 
    P_SL IN CTHD.SL%TYPE
)
AS
BEGIN
    INSERT INTO CTHD (SOHD, MASP, SL) 
    VALUES (P_SOHD, P_MASP, P_SL);
    
    UPDATE HOADON
    SET TRIGIA = (SELECT SUM(CT.SL * SP.GIATIEN) 
                  FROM CTHD CT
                  JOIN SANPHAM SP ON CT.MASP = SP.MASP 
                  WHERE CT.SOHD = P_SOHD)
    WHERE SOHD = P_SOHD;
END;

--2) Xoa chi tiet hoa don 
CREATE OR REPLACE PROCEDURE SP_XOA_CTHD (
    P_SOHD IN CTHD.SOHD%TYPE,
    P_MASP IN CTHD.MASP%TYPE 
)
AS 
BEGIN
    DELETE FROM CTHD WHERE SOHD = P_SOHD AND MASP = P_MASP;
    
    UPDATE HOADON
    SET TRIGIA = (SELECT SUM(CT.SL * SP.GIATIEN) 
                  FROM CTHD CT
                  JOIN SANPHAM SP ON CT.MASP = SP.MASP 
                  WHERE CT.SOHD = P_SOHD)
    WHERE SOHD = P_SOHD;
END;